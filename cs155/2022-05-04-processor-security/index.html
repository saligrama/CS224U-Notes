<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Processor security # The processor # Part of the trusted computing base (TCB) But is optimized for performance Security may be secondary Processor design and security: Important security features Hardware enclaves Memory encryption (TME) RDRAND etc. Some features can be exploited for attacks Speculative execution Transactional memory Intel Software Guard eXstensions (SGX) # Extension to Intel processors that support Enclaves: running code and memory isolated from rest of system Attestation: prove to local/remote system what code is running in enclave Minimum TCB: only processor is trusted and nothing else DRAM and peripherals are untrusted Writes to memory are encrypted Applications Storing a web server HTTPS secret key: secret key only opened inside an enclave Malware cannot get the key Note: this is different from TPM2 - TPM2 only provides secure storage at boot, after that it&rsquo;s all in memory Running a private job in the cloud: job runs in enclave Cloud admin cannot get code or data or job Client side: hide antivirus signatures AV signatures are only opened inside an enclave Data science on federated data Compute on shared data, without ever having to share the data with anyone else SGX now deprecated in consumer CPUs, only available in server CPUs SGX enclaves # Application defines part of itself as an enclave Untrusted part of memory creates enclave Enclave is isolated memory in process memory space Inaccessible while processor is not in SGX mode Untrusted part can call a trusted function in the enclave To do execution, processor goes into SGX mode Creating en enclave: ECREATE: establish mem addr for enclave EADD: copy memory pages into enclave EEXTEND: compute hash of enclave contents, 256 bytes at a time EINIT: verifies that hashed content is properly signed; if so, initializes enclave (signature: RSA3072) EENTER: call function inside enclave EEXIT: return from enclave SGX attestation # Problem: enclave memory is in the clear prior to activation (EINIT) How to get secrets into enclave?"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content><meta property="og:description" content="Processor security # The processor # Part of the trusted computing base (TCB) But is optimized for performance Security may be secondary Processor design and security: Important security features Hardware enclaves Memory encryption (TME) RDRAND etc. Some features can be exploited for attacks Speculative execution Transactional memory Intel Software Guard eXstensions (SGX) # Extension to Intel processors that support Enclaves: running code and memory isolated from rest of system Attestation: prove to local/remote system what code is running in enclave Minimum TCB: only processor is trusted and nothing else DRAM and peripherals are untrusted Writes to memory are encrypted Applications Storing a web server HTTPS secret key: secret key only opened inside an enclave Malware cannot get the key Note: this is different from TPM2 - TPM2 only provides secure storage at boot, after that it&rsquo;s all in memory Running a private job in the cloud: job runs in enclave Cloud admin cannot get code or data or job Client side: hide antivirus signatures AV signatures are only opened inside an enclave Data science on federated data Compute on shared data, without ever having to share the data with anyone else SGX now deprecated in consumer CPUs, only available in server CPUs SGX enclaves # Application defines part of itself as an enclave Untrusted part of memory creates enclave Enclave is isolated memory in process memory space Inaccessible while processor is not in SGX mode Untrusted part can call a trusted function in the enclave To do execution, processor goes into SGX mode Creating en enclave: ECREATE: establish mem addr for enclave EADD: copy memory pages into enclave EEXTEND: compute hash of enclave contents, 256 bytes at a time EINIT: verifies that hashed content is properly signed; if so, initializes enclave (signature: RSA3072) EENTER: call function inside enclave EEXIT: return from enclave SGX attestation # Problem: enclave memory is in the clear prior to activation (EINIT) How to get secrets into enclave?"><meta property="og:type" content="article"><meta property="og:url" content="https://saligrama.io/notes/cs155/2022-05-04-processor-security/"><meta property="article:section" content="cs155"><title>Processor Security | Aditya's notes</title><link rel=manifest href=/notes/manifest.json><link rel=icon href=/notes/favicon.png type=image/x-icon><link rel=stylesheet href=/notes/book.min.395a67680f48b8d23bbf267f26d0d1259e69554b2b704e371e8e15cbe656e05f.css integrity="sha256-OVpnaA9IuNI7vyZ/JtDRJZ5pVUsrcE43Ho4Vy+ZW4F8=" crossorigin=anonymous><script defer src=/notes/flexsearch.min.js></script>
<script defer src=/notes/en.search.min.c7487c651e8b0649832a9860edbf56fae7c4a813000e9a4c548a923fea6af0d5.js integrity="sha256-x0h8ZR6LBkmDKphg7b9W+ufEqBMADppMVIqSP+pq8NU=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/notes/><span>Aditya's notes</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-a88f46c31d1ebdf165810583424fda37 class=toggle>
<label for=section-a88f46c31d1ebdf165810583424fda37 class="flex justify-between"><a role=button>CS 103, Fall 2020</a></label><ul><li><a href=/notes/cs103/2020-09-16-set-theory/>Set Theory</a></li><li><a href=/notes/cs103/2020-09-18-indirect-proofs/>Indirect Proofs</a></li><li><a href=/notes/cs103/2020-09-18-mathematical-proofs/>Mathematical Proofs</a></li><li><a href=/notes/cs103/2020-09-26-first-order-logic/>First Order Logic</a></li><li><a href=/notes/cs103/2020-09-26-propositional-logic/>Propositional Logic</a></li><li><a href=/notes/cs103/2020-09-27-first-order-logic-continued/>First Order Logic Continued</a></li><li><a href=/notes/cs103/2020-09-30-binary-relations/>Binary Relations</a></li><li><a href=/notes/cs103/2020-10-01-binary-relations-continued/>Binary Relations Continued</a></li><li><a href=/notes/cs103/2020-10-04-functions/>Functions</a></li><li><a href=/notes/cs103/2020-10-10-cardinality/>Cardinality</a></li><li><a href=/notes/cs103/2020-10-11-graph-theory/>Graph Theory</a></li><li><a href=/notes/cs103/2020-10-17-pigeonhole-principle/>Pigeonhole Principle</a></li><li><a href=/notes/cs103/2020-10-18-induction/>Induction</a></li><li><a href=/notes/cs103/2020-10-19-induction-variants/>Induction Variants</a></li><li><a href=/notes/cs103/2020-10-20-computability-and-formal-languages/>Computability and Formal Languages</a></li><li><a href=/notes/cs103/2020-10-25-nondeterministic-finite-automata/>Nondeterministic Finite Automata</a></li><li><a href=/notes/cs103/2020-10-26-nfa-dfa-equivalence/>Nfa Dfa Equivalence</a></li><li><a href=/notes/cs103/2020-10-26-regular-expressions/>Regular Expressions</a></li><li><a href=/notes/cs103/2020-11-01-nonregular-languages/>Nonregular Languages</a></li><li><a href=/notes/cs103/2020-11-02-context-free-grammars/>Context Free Grammars</a></li><li><a href=/notes/cs103/2020-11-03-turing-machines/>Turing Machines</a></li><li><a href=/notes/cs103/2020-11-08-turing-machine-subroutines/>Turing Machine Subroutines</a></li><li><a href=/notes/cs103/2020-11-08-universal-turing-machine/>Universal Turing Machine</a></li><li><a href=/notes/cs103/2020-11-08-unsolvable-problems/>Unsolvable Problems</a></li><li><a href=/notes/cs103/2020-11-14-unsolvable-problems-continued/>Unsolvable Problems Continued</a></li></ul></li><li><input type=checkbox id=section-cf13475a7a80a5dd57b5a55dce73d171 class=toggle>
<label for=section-cf13475a7a80a5dd57b5a55dce73d171 class="flex justify-between"><a role=button>CS 107, Fall 2020</a></label><ul><li><a href=/notes/cs107/2020-09-18-integer-representations/>Integer Representations</a></li><li><a href=/notes/cs107/2020-09-21-bitwise-operations/>Bitwise Operations</a></li><li><a href=/notes/cs107/2020-09-25-c-chars-and-strings/>C Chars and Strings</a></li><li><a href=/notes/cs107/2020-09-28-more-c-strings/>More C Strings</a></li><li><a href=/notes/cs107/2020-10-02-pointers-arrays/>Pointers Arrays</a></li><li><a href=/notes/cs107/2020-10-05-stack-and-heap/>Stack and Heap</a></li><li><a href=/notes/cs107/2020-10-09-c-generics/>C Generics</a></li><li><a href=/notes/cs107/2020-10-12-function-pointers/>Function Pointers</a></li><li><a href=/notes/cs107/2020-10-16-assembly/>Assembly</a></li><li><a href=/notes/cs107/2020-10-19-assembly-arithmetic-logic/>Assembly Arithmetic Logic</a></li><li><a href=/notes/cs107/2020-10-23-assembly-control-flow/>Assembly Control Flow</a></li><li><a href=/notes/cs107/2020-10-26-assembly-function-calls-and-return-stack/>Assembly Function Calls and Return Stack</a></li><li><a href=/notes/cs107/2020-10-30-heap-management/>Heap Management</a></li><li><a href=/notes/cs107/2020-11-09-program-optimization/>Program Optimization</a></li></ul></li><li><input type=checkbox id=section-4e3bc6e2f7a0feae33c3e43356d49c80 class=toggle>
<label for=section-4e3bc6e2f7a0feae33c3e43356d49c80 class="flex justify-between"><a role=button>CS 110L, Spring 2021</a></label><ul><li><a href=/notes/cs110l/2021-03-30-course-overview/>Course Overview</a></li><li><a href=/notes/cs110l/2021-04-01-fixing-c/>Fixing C</a></li><li><a href=/notes/cs110l/2021-04-06-intro-to-rust/>Intro to Rust</a></li><li><a href=/notes/cs110l/2021-04-08-ownership/>Ownership</a></li><li><a href=/notes/cs110l/2021-04-13-error-handling/>Error Handling</a></li><li><a href=/notes/cs110l/2021-04-22-traits/>Traits</a></li><li><a href=/notes/cs110l/2021-04-27-generics/>Generics</a></li><li><a href=/notes/cs110l/2021-04-29-multiprocessing/>Multiprocessing</a></li></ul></li><li><input type=checkbox id=section-23e7773af736437c02202412a988f2db class=toggle>
<label for=section-23e7773af736437c02202412a988f2db class="flex justify-between"><a role=button>CS 111, Spring 2021</a></label><ul><li><a href=/notes/cs111/2021-03-31-threads-and-dispatching/>Threads and Dispatching</a></li><li><a href=/notes/cs111/2021-04-02-concurrency/>Concurrency</a></li><li><a href=/notes/cs111/2021-04-05-synchronization/>Synchronization</a></li><li><a href=/notes/cs111/2021-04-07-shared-memory-and-condition-variables-and-locks/>Shared Memory and Condition Variables and Locks</a></li><li><a href=/notes/cs111/2021-04-09-lock-implementation-and-deadlocking/>Lock Implementation and Deadlocking</a></li><li><a href=/notes/cs111/2021-04-12-scheduling/>Scheduling</a></li><li><a href=/notes/cs111/2021-04-14-multiprocessing/>Multiprocessing</a></li><li><a href=/notes/cs111/2021-04-16-linking/>Linking</a></li><li><a href=/notes/cs111/2021-04-19-storage-management/>Storage Management</a></li><li><a href=/notes/cs111/2021-04-21-virtual-memory/>Virtual Memory</a></li><li><a href=/notes/cs111/2021-04-23-dynamic-address-translation/>Dynamic Address Translation</a></li><li><a href=/notes/cs111/2021-04-26-segmentation-and-paging/>Segmentation and Paging</a></li><li><a href=/notes/cs111/2021-04-30-demand-paging/>Demand Paging</a></li><li><a href=/notes/cs111/2021-05-05-disks/>Disks</a></li><li><a href=/notes/cs111/2021-05-07-file-systems/>File Systems</a></li><li><a href=/notes/cs111/2021-05-10-realworld-filesystem-structures/>Realworld Filesystem Structures</a></li><li><a href=/notes/cs111/2021-05-12-directories/>Directories</a></li><li><a href=/notes/cs111/2021-05-14-crash-recovery/>Crash Recovery</a></li><li><a href=/notes/cs111/2021-05-19-protection/>Protection</a></li><li><a href=/notes/cs111/2021-05-24-flash-memory/>Flash Memory</a></li><li><a href=/notes/cs111/2021-05-28-virtual-machines/>Virtual Machines</a></li></ul></li><li><input type=checkbox id=section-a586b190ebf0a4874cd21a1d76743261 class=toggle>
<label for=section-a586b190ebf0a4874cd21a1d76743261 class="flex justify-between"><a role=button>CS 143, Spring 2022</a></label><ul><li><a href=/notes/cs143/2022-03-29-intro/>Intro</a></li><li><a href=/notes/cs143/2022-03-31-language-design-and-cool/>Language Design and Cool</a></li><li><a href=/notes/cs143/2022-04-05-lexical-analysis/>Lexical Analysis</a></li><li><a href=/notes/cs143/2022-04-07-lexical-analysis-implementation/>Lexical Analysis Implementation</a></li><li><a href=/notes/cs143/2022-04-12-parsing/>Parsing</a></li><li><a href=/notes/cs143/2022-04-14-syntax-directed-translation/>Syntax Directed Translation</a></li><li><a href=/notes/cs143/2022-04-19-top-down-parsing/>Top Down Parsing</a></li><li><a href=/notes/cs143/2022-04-26-semantic-analysis/>Semantic Analysis</a></li></ul></li><li><input type=checkbox id=section-37836de7a703e433b2642097d511f482 class=toggle>
<label for=section-37836de7a703e433b2642097d511f482 class="flex justify-between"><a role=button>CS 149, Fall 2022</a></label><ul><li><a href=/notes/cs149/2022-09-27-intro/>Intro</a></li><li><a href=/notes/cs149/2022-09-29-modern-multicore-processors/>Modern Multicore Processors</a></li><li><a href=/notes/cs149/2022-10-04-parallel-abstractions/>Parallel Abstractions</a></li></ul></li><li><input type=checkbox id=section-4f9fa520660f975442d4640415905b3c class=toggle>
<label for=section-4f9fa520660f975442d4640415905b3c class="flex justify-between"><a role=button>CS 154, Fall 2021</a></label><ul><li><a href=/notes/cs154/2021-09-28-finite-automata/>Finite Automata</a></li><li><a href=/notes/cs154/2021-10-05-pumping-lemma-and-myhill-nerode/>Pumping Lemma and Myhill Nerode</a></li><li><a href=/notes/cs154/2021-10-12-streaming-algorithms-and-turing-machines/>Streaming Algorithms and Turing Machines</a></li></ul></li><li><input type=checkbox id=section-d24cd7d7d21fe73135d596a09b50887f class=toggle checked>
<label for=section-d24cd7d7d21fe73135d596a09b50887f class="flex justify-between"><a role=button>CS 155, Spring 2022</a></label><ul><li><a href=/notes/cs155/2022-03-28-intro/>Intro</a></li><li><a href=/notes/cs155/2022-03-30-control-hijacking/>Control Hijacking</a></li><li><a href=/notes/cs155/2022-04-04-control-hijacking-defenses/>Control Hijacking Defenses</a></li><li><a href=/notes/cs155/2022-04-06-security-principles/>Security Principles</a></li><li><a href=/notes/cs155/2022-04-11-isolation-and-sandboxing/>Isolation and Sandboxing</a></li><li><a href=/notes/cs155/2022-04-13-vuln-finding/>Vuln Finding</a></li><li><a href=/notes/cs155/2022-04-18-web-security/>Web Security</a></li><li><a href=/notes/cs155/2022-04-20-web-attacks/>Web Attacks</a></li><li><a href=/notes/cs155/2022-04-25-web-defenses/>Web Defenses</a></li><li><a href=/notes/cs155/2022-05-04-processor-security/ class=active>Processor Security</a></li><li><a href=/notes/cs155/2022-05-09-internet-protocol-security/>Internet Protocol Security</a></li></ul></li><li><input type=checkbox id=section-471622039e8d87cd8d642483c8d218b8 class=toggle>
<label for=section-471622039e8d87cd8d642483c8d218b8 class="flex justify-between"><a role=button>CS 161, Winter 2022</a></label><ul><li><a href=/notes/cs161/2022-01-03-intro/>Intro</a></li><li><a href=/notes/cs161/2022-01-05-worst-case-and-asymptotic-analysis/>Worst Case and Asymptotic Analysis</a></li><li><a href=/notes/cs161/2022-01-10-recurrence-relations/>Recurrence Relations</a></li><li><a href=/notes/cs161/2022-01-12-median-and-selection/>Median and Selection</a></li><li><a href=/notes/cs161/2022-01-19-randomized-algorithms-and-quicksort/>Randomized Algorithms and Quicksort</a></li><li><a href=/notes/cs161/2022-01-24-sorting-lower-bounds/>Sorting Lower Bounds</a></li><li><a href=/notes/cs161/2022-01-26-binary-search-trees/>Binary Search Trees</a></li><li><a href=/notes/cs161/2022-01-31-hashing/>Hashing</a></li><li><a href=/notes/cs161/2022-02-02-graphs-and-graph-search/>Graphs and Graph Search</a></li><li><a href=/notes/cs161/2022-02-07-strongly-connected-components/>Strongly Connected Components</a></li><li><a href=/notes/cs161/2022-02-09-weighted-graphs-and-dijkstra/>Weighted Graphs and Dijkstra</a></li><li><a href=/notes/cs161/2022-02-14-dynamic-programming/>Dynamic Programming</a></li><li><a href=/notes/cs161/2022-02-16-dynamic-programming-applications/>Dynamic Programming Applications</a></li><li><a href=/notes/cs161/2022-02-23-greedy-algorithms/>Greedy Algorithms</a></li><li><a href=/notes/cs161/2022-02-28-minimum-spanning-trees/>Minimum Spanning Trees</a></li></ul></li><li><input type=checkbox id=section-0794dc87987599843ba69a8ea82e9b6a class=toggle>
<label for=section-0794dc87987599843ba69a8ea82e9b6a class="flex justify-between"><a role=button>CS 224U, Spring 2021</a></label><ul><li><a href=/notes/cs224u/2021-03-29-course-overview/>Course Overview</a></li><li><a href=/notes/cs224u/2021-03-31-vector-space-models/>Vector Space Models</a></li><li><a href=/notes/cs224u/2021-04-12-sentiment-analysis/>Sentiment Analysis</a></li></ul></li><li><input type=checkbox id=section-efae8264f5fe410feb1b40be6f99baea class=toggle>
<label for=section-efae8264f5fe410feb1b40be6f99baea class="flex justify-between"><a role=button>CS 229, Fall 2021</a></label><ul><li><a href=/notes/cs229/2021-09-21-intro/>Intro</a></li><li><a href=/notes/cs229/2021-09-23-supervised-learning-setup/>Supervised Learning Setup</a></li><li><a href=/notes/cs229/2021-09-28-logistic-regression/>Logistic Regression</a></li><li><a href=/notes/cs229/2021-09-30-generalized-linear-models/>Generalized Linear Models</a></li><li><a href=/notes/cs229/2021-10-05-generative-learning-algorithms/>Generative Learning Algorithms</a></li><li><a href=/notes/cs229/2021-10-07-naive-bayes/>Naive Bayes</a></li><li><a href=/notes/cs229/2021-10-12-kernel-methods-and-svm/>Kernel Methods and Svm</a></li><li><a href=/notes/cs229/2021-10-14-deep-learning/>Deep Learning</a></li><li><a href=/notes/cs229/2021-10-19-deep-learning-optimization/>Deep Learning Optimization</a></li><li><a href=/notes/cs229/2021-10-21-model-selection/>Model Selection</a></li></ul></li><li><input type=checkbox id=section-292ea4e126876f1048e61c4dc744546c class=toggle>
<label for=section-292ea4e126876f1048e61c4dc744546c class="flex justify-between"><a role=button>CS 251, Fall 2022</a></label><ul><li><a href=/notes/cs251/2022-09-26-intro/>Intro</a></li><li><a href=/notes/cs251/2022-09-28-bitcoin-mechanics/>Bitcoin Mechanics</a></li><li><a href=/notes/cs251/2022-10-03-bitcoin-scripts-and-wallets/>Bitcoin Scripts and Wallets</a></li></ul></li><li><input type=checkbox id=section-98d861db134658b3e020a9d74c50ad24 class=toggle>
<label for=section-98d861db134658b3e020a9d74c50ad24 class="flex justify-between"><a role=button>CS 255, Winter 2022</a></label><ul><li><a href=/notes/cs255/2022-01-03-intro/>Intro</a></li><li><a href=/notes/cs255/2022-01-05-stream-ciphers/>Stream Ciphers</a></li><li><a href=/notes/cs255/2022-01-10-block-ciphers/>Block Ciphers</a></li><li><a href=/notes/cs255/2022-01-12-pseudorandom-functions/>Pseudorandom Functions</a></li><li><a href=/notes/cs255/2022-01-19-data-integrity-and-macs/>Data Integrity and Macs</a></li><li><a href=/notes/cs255/2022-01-24-collision-resistance/>Collision Resistance</a></li><li><a href=/notes/cs255/2022-01-26-authenticated-encryption/>Authenticated Encryption</a></li><li><a href=/notes/cs255/2022-01-31-key-management/>Key Management</a></li><li><a href=/notes/cs255/2022-02-02-key-exchange-math/>Key Exchange Math</a></li><li><a href=/notes/cs255/2022-02-07-public-key-encryption/>Public Key Encryption</a></li><li><a href=/notes/cs255/2022-02-09-pke-schemes/>Pke Schemes</a></li><li><a href=/notes/cs255/2022-02-14-digital-signatures/>Digital Signatures</a></li><li><a href=/notes/cs255/2022-02-16-certificates/>Certificates</a></li><li><a href=/notes/cs255/2022-02-23-id-protocols/>Id Protocols</a></li><li><a href=/notes/cs255/2022-02-28-key-exchange-protocols/>Key Exchange Protocols</a></li><li><a href=/notes/cs255/2022-03-02-zero-knowledge-protocols/>Zero Knowledge Protocols</a></li><li><a href=/notes/cs255/2022-03-07-quantum-cryptography/>Quantum Cryptography</a></li></ul></li><li><input type=checkbox id=section-568ed1bc8289796d56a6d06a22d7eb40 class=toggle>
<label for=section-568ed1bc8289796d56a6d06a22d7eb40 class="flex justify-between"><a role=button>INTLPOL 268, Fall 2021</a></label><ul><li><a href=/notes/intlpol268/2021-09-20-intro/>Intro</a></li><li><a href=/notes/intlpol268/2021-09-22-legal-intro-and-electronic-communications-privacy-act/>Legal Intro and Electronic Communications Privacy Act</a></li><li><a href=/notes/intlpol268/2021-09-27-web-requests-and-attacks/>Web Requests and Attacks</a></li><li><a href=/notes/intlpol268/2021-09-29-ecpa-for-private-actors/>Ecpa for Private Actors</a></li><li><a href=/notes/intlpol268/2021-10-04-cyberattacks/>Cyberattacks</a></li><li><a href=/notes/intlpol268/2021-10-06-computer-fraud-and-abuse-act/>Computer Fraud and Abuse Act</a></li><li><a href=/notes/intlpol268/2021-10-11-network-security/>Network Security</a></li><li><a href=/notes/intlpol268/2021-10-13-cfaa-dmca-and-security-research/>Cfaa Dmca and Security Research</a></li><li><a href=/notes/intlpol268/2021-10-20-data-security-laws/>Data Security Laws</a></li><li><a href=/notes/intlpol268/2021-10-25-corporate-intrusion/>Corporate Intrusion</a></li><li><a href=/notes/intlpol268/2021-10-27-ransomware-and-foreign-hackers/>Ransomware and Foreign Hackers</a></li><li><a href=/notes/intlpol268/2021-11-01-cryptography/>Cryptography</a></li><li><a href=/notes/intlpol268/2021-11-03-cyber-conflict/>Cyber Conflict</a></li><li><a href=/notes/intlpol268/2021-11-08-dark-web-and-cryptocurrencies/>Dark Web and Cryptocurrencies</a></li><li><a href=/notes/intlpol268/2021-11-10-encryption-and-technical-assistance/>Encryption and Technical Assistance</a></li><li><a href=/notes/intlpol268/2021-11-15-malware/>Malware</a></li><li><a href=/notes/intlpol268/2021-11-17-government-hacking/>Government Hacking</a></li><li><a href=/notes/intlpol268/2021-11-29-new-frontiers/>New Frontiers</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/notes/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Processor Security</strong>
<label for=toc-control><img src=/notes/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#processor-security>Processor security</a><ul><li><a href=#the-processor>The processor</a></li><li><a href=#intel-software-guard-exstensions-sgx>Intel Software Guard eXstensions (SGX)</a><ul><li><a href=#sgx-enclaves>SGX enclaves</a></li><li><a href=#sgx-attestation>SGX attestation</a></li><li><a href=#sgx-insecurity>SGX insecurity</a></li></ul></li><li><a href=#the-spectre-attack>The Spectre attack</a><ul><li><a href=#background>Background</a></li><li><a href=#conditional-branch-variant-1-attack>Conditional branch (Variant 1) attack</a></li><li><a href=#indirect-branch-variant-2-attack>Indirect branch (Variant 2) attack</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=processor-security>Processor security
<a class=anchor href=#processor-security>#</a></h1><h2 id=the-processor>The processor
<a class=anchor href=#the-processor>#</a></h2><ul><li>Part of the trusted computing base (TCB)<ul><li>But is optimized for performance</li><li>Security may be secondary</li></ul></li><li>Processor design and security:<ul><li>Important security features<ul><li>Hardware enclaves</li><li>Memory encryption (TME)</li><li>RDRAND</li><li>etc.</li></ul></li><li>Some features can be exploited for attacks<ul><li>Speculative execution</li><li>Transactional memory</li></ul></li></ul></li></ul><h2 id=intel-software-guard-exstensions-sgx>Intel Software Guard eXstensions (SGX)
<a class=anchor href=#intel-software-guard-exstensions-sgx>#</a></h2><ul><li>Extension to Intel processors that support<ul><li>Enclaves: running code and memory isolated from rest of system</li><li>Attestation: prove to local/remote system what code is running in enclave</li><li>Minimum TCB: only processor is trusted and nothing else<ul><li>DRAM and peripherals are untrusted</li><li>Writes to memory are encrypted</li></ul></li></ul></li><li>Applications<ul><li>Storing a web server HTTPS secret key: secret key only opened inside an enclave<ul><li>Malware cannot get the key</li><li>Note: this is different from TPM2 - TPM2 only provides secure storage at boot, after that it&rsquo;s all in memory</li></ul></li><li>Running a private job in the cloud: job runs in enclave<ul><li>Cloud admin cannot get code or data or job</li></ul></li><li>Client side: hide antivirus signatures<ul><li>AV signatures are only opened inside an enclave</li></ul></li><li>Data science on federated data<ul><li>Compute on shared data, without ever having to share the data with anyone else</li></ul></li><li>SGX now deprecated in consumer CPUs, only available in server CPUs</li></ul></li></ul><h3 id=sgx-enclaves>SGX enclaves
<a class=anchor href=#sgx-enclaves>#</a></h3><ul><li>Application defines part of itself as an enclave</li><li>Untrusted part of memory creates enclave</li><li>Enclave is isolated memory in process memory space<ul><li>Inaccessible while processor is not in SGX mode</li></ul></li><li>Untrusted part can call a trusted function in the enclave<ul><li>To do execution, processor goes into SGX mode</li></ul></li><li>Creating en enclave:<ul><li><code>ECREATE</code>: establish mem addr for enclave</li><li><code>EADD</code>: copy memory pages into enclave</li><li><code>EEXTEND</code>: compute hash of enclave contents, 256 bytes at a time</li><li><code>EINIT</code>: verifies that hashed content is properly signed; if so, initializes enclave (signature: RSA3072)</li><li><code>EENTER</code>: call function inside enclave</li><li><code>EEXIT</code>: return from enclave
<img src=img/2022-05-04-sgx-enclave.png alt="SGX enclave"></li></ul></li></ul><h3 id=sgx-attestation>SGX attestation
<a class=anchor href=#sgx-attestation>#</a></h3><ul><li>Problem: enclave memory is in the clear prior to activation (<code>EINIT</code>)</li><li>How to get secrets into enclave?</li></ul><p><img src=img/2022-05-04-sgx-attestation.png alt="SGX attestaton"></p><h3 id=sgx-insecurity>SGX insecurity
<a class=anchor href=#sgx-insecurity>#</a></h3><ul><li>Side channels: attacker controls the OS, OS sees lots of side-channel info<ul><li>Memory access patterns</li><li>State of processor caches as enclave executes</li><li>State of branch predictor</li></ul></li><li>Extract quoting key<ul><li>Attestation: proves to 3rd party what code is running in enclave<ul><li>Quoting sk stored in Intel enclave on untrusted machines</li></ul></li><li>What if attacker extracts sk from <em>some</em> quoting enclave?<ul><li>Can attest to arbitrary non-enclave code</li></ul></li></ul></li></ul><h2 id=the-spectre-attack>The Spectre attack
<a class=anchor href=#the-spectre-attack>#</a></h2><h3 id=background>Background
<a class=anchor href=#background>#</a></h3><ul><li>CPU optimizations<ul><li>Clock speed maxed out: Pentium 4 (2004) reached 3.8 GHz</li><li>Memory latency is slow and not improving much</li><li>To gain CPU performance, need to do more per cycle<ul><li>Reduce memory delays: caches</li><li>Work during delays: speculative execution</li></ul></li></ul></li><li>Memory caches<ul><li>Hold local (fast) copy of recently-addressed 64-byte chunks of memory
<img src=img/2022-05-04-mem-cache.png alt="Memory cache"></li></ul></li><li>Speculative execution<ul><li>At a branch: CPU will guess that the code will go in one direction and start executing that code while waiting for branch result</li><li>When result comes back, if it is wrong direction, throw away the work and start executing that direction</li></ul></li><li>Mitigations to the below attacks are still an active area of research</li><li>Other speculative execution attacks also exist (e.g. Meltdown)</li></ul><h3 id=conditional-branch-variant-1-attack>Conditional branch (Variant 1) attack
<a class=anchor href=#conditional-branch-variant-1-attack>#</a></h3><p>e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ff79c6>if</span> (x <span style=color:#ff79c6>&lt;</span> array1_size)
</span></span><span style=display:flex><span>    y <span style=color:#ff79c6>=</span> array2[array1[x] <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>4096</span>];
</span></span></code></pre></div><ul><li>Suppose memory at <code>array1</code> base is 8 bytes of data that doesn&rsquo;t matter<ul><li>Memory at <code>array1</code> base + 1000: something secret</li></ul></li><li>Suppose <code>unsigned int x</code> comes from untrusted caller</li><li>Execution without speculation is safe:
<code>array2[array1[x]*4096]</code> is not evaluated unless <code>x &lt; array1_size</code></li><li>Before attack:<ul><li>Train branch predictor to expect <code>if()</code> is true: e.g. call with <code>x &lt; array1_size</code></li><li>Evict <code>array1_size</code> and <code>array2[]</code> from cache</li></ul></li><li>Attacker calls victim with <code>x = 1000</code></li><li>Speculative exec while waiting for <code>array1_size</code>:<ul><li>Predict that <code>if()</code> is true</li><li>Read address (<code>array1</code> base + x)<ul><li>Using out-of-bounds <code>x=1000</code></li></ul></li><li>Read returns secret byte (in cache - fast)</li><li>Brings <code>array2[BYTE * 4096]</code> brought into the cache</li><li>CPU realizes <code>if()</code> is false, discards speculative work<ul><li>But leaves <code>BYTE</code> in the cache</li></ul></li></ul></li><li>Attacker (another process or core):<ul><li><code>for i = 0...255</code>: measure read time for <code>array2[i * 4096]</code></li><li>When <code>i = BYTE</code> read is fast (cached), this reveals the secret <code>BYTE</code></li></ul></li><li>Mitigation: speculation stopping instruction (e.g. <code>LFENCE</code>)<ul><li>Idea: insert <code>LFENCE</code> on <em>all</em> vulnerable code paths</li><li>Need to do so in a non-manual way that does not compromise performance</li><li>Insertion by smart compiler: supported in LLVM<ul><li>Requires compiler to be aware of specific CPU designs</li></ul></li></ul></li></ul><h3 id=indirect-branch-variant-2-attack>Indirect branch (Variant 2) attack
<a class=anchor href=#indirect-branch-variant-2-attack>#</a></h3><ul><li>Indirect branches: can go anywhere, e.g. <code>jmp [rax]</code><ul><li>If destination is delayed, CPU guesses and proceeds speculatively</li><li>Find an indirect <code>jmp</code> with an attacker controlled register<ul><li>Then cause mispredict to a useful gadget</li></ul></li></ul></li><li>Attack steps:<ul><li>Mistrain branch prediction so spec-ex will go to gadget</li><li>Evict address <code>[rax]</code> from cache to cause spec-ex</li><li>Execute victim so it spec-runs gadget</li><li>Detect change in cache state to determine memory data</li></ul></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#processor-security>Processor security</a><ul><li><a href=#the-processor>The processor</a></li><li><a href=#intel-software-guard-exstensions-sgx>Intel Software Guard eXstensions (SGX)</a><ul><li><a href=#sgx-enclaves>SGX enclaves</a></li><li><a href=#sgx-attestation>SGX attestation</a></li><li><a href=#sgx-insecurity>SGX insecurity</a></li></ul></li><li><a href=#the-spectre-attack>The Spectre attack</a><ul><li><a href=#background>Background</a></li><li><a href=#conditional-branch-variant-1-attack>Conditional branch (Variant 1) attack</a></li><li><a href=#indirect-branch-variant-2-attack>Indirect branch (Variant 2) attack</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>